name: Release

on:
  push:
    tags:
      - '*-*'

permissions:
  contents: write

jobs:
  setup:
    name: Setup Release
    runs-on: ubuntu-latest
    outputs:
      module: ${{ steps.parse_tag.outputs.module }}
      version: ${{ steps.parse_tag.outputs.version }}
      artifact_name: ${{ steps.parse_tag.outputs.artifact_name }}
    steps:
      - name: Parse Tag
        id: parse_tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Tag: $TAG"
          
          # Extract module (everything before the first hyphen followed by a digit)
          MODULE=${TAG%%-[0-9]*}
          # Extract version (remove module and hyphen from tag)
          VERSION=${TAG#$MODULE-}
          
          echo "Module: $MODULE"
          echo "Version: $VERSION"
          
          echo "module=$MODULE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact_name=mcp-$MODULE-server" >> $GITHUB_OUTPUT

  test:
    name: Run Tests
    needs: setup
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Run tests
        env:
          DB_KIND: postgresql
          DB_URL: jdbc:postgresql://localhost:5432/testdb
          DB_USERNAME: testuser
          DB_PASSWORD: testpass
        run: mvn --batch-mode clean verify -pl ${{ needs.setup.outputs.module }} -am -Drevision=${{ needs.setup.outputs.version }}

  build-jar:
    name: Build JAR
    runs-on: ubuntu-latest
    needs: [setup, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build uber-jar
        run: mvn --batch-mode clean package -pl ${{ needs.setup.outputs.module }} -am -DskipTests -Drevision=${{ needs.setup.outputs.version }}

      - name: Generate JAR checksum
        run: |
          cd ${{ needs.setup.outputs.module }}/target
          ARTIFACT_NAME=${{ needs.setup.outputs.artifact_name }}
          VERSION=${{ needs.setup.outputs.version }}
          sha256sum ${ARTIFACT_NAME}-${VERSION}.jar > ${ARTIFACT_NAME}-${VERSION}.jar.sha256

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar
          path: |
            ${{ needs.setup.outputs.module }}/target/${{ needs.setup.outputs.artifact_name }}-*.jar
            ${{ needs.setup.outputs.module }}/target/${{ needs.setup.outputs.artifact_name }}-*.jar.sha256

  build-native:
    name: Build Native Binary (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    needs: [setup, test]

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: macos-14
            platform: macos-arm64
            macos_target: "11.0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm-community'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build native binary
        run: mvn --batch-mode package -pl ${{ needs.setup.outputs.module }} -am -Dnative -DskipTests -Drevision=${{ needs.setup.outputs.version }}
        env:
          MAVEN_OPTS: "-Xmx4g"
          MACOSX_DEPLOYMENT_TARGET: ${{ matrix.macos_target || '' }}

      - name: Find and verify native binary
        id: find_binary
        run: |
          MODULE=${{ needs.setup.outputs.module }}
          ARTIFACT_NAME=${{ needs.setup.outputs.artifact_name }}
          
          # Find the native binary
          BINARY=$(find $MODULE/target -type f -name "${ARTIFACT_NAME}-*" ! -name '*.jar' ! -name '*.json' ! -name '*.txt' | head -n1)
          if [ -z "$BINARY" ]; then
            echo "Native binary not found!"
            exit 1
          fi
          echo "Found binary: $BINARY"
          ls -lh "$BINARY"
          echo "binary_path=$BINARY" >> $GITHUB_OUTPUT

      - name: Rename and checksum native binary
        run: |
          BINARY=${{ steps.find_binary.outputs.binary_path }}
          BINARY_DIR=$(dirname "$BINARY")
          BINARY_NAME=$(basename "$BINARY")
          RENAMED="${BINARY_NAME}-${{ matrix.platform }}"

          cd "$BINARY_DIR"
          mv "$BINARY_NAME" "$RENAMED"
          if [[ "$OSTYPE" == "darwin"* ]]; then
            shasum -a 256 "$RENAMED" > "${RENAMED}.sha256"
          else
            sha256sum "$RENAMED" > "${RENAMED}.sha256"
          fi

      - name: Upload native binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.platform }}
          path: |
            ${{ needs.setup.outputs.module }}/target/${{ needs.setup.outputs.artifact_name }}-*-${{ matrix.platform }}
            ${{ needs.setup.outputs.module }}/target/${{ needs.setup.outputs.artifact_name }}-*-${{ matrix.platform }}.sha256

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [setup, test, build-jar, build-native]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: ls -R artifacts/

      - name: Prepare release files
        run: |
          mkdir release-files
          ARTIFACT_NAME=${{ needs.setup.outputs.artifact_name }}
          find artifacts -type f -name "${ARTIFACT_NAME}-*" -exec cp {} release-files/ \;
          ls -lh release-files/

      - name: Generate release notes
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          REPO=${{ github.repository }}
          ARTIFACT_NAME=${{ needs.setup.outputs.artifact_name }}

          # Generate release notes from template
          sed -e "s|VERSION|${VERSION}|g" \
              -e "s|REPO|${REPO}|g" \
              -e "s|ARTIFACT_NAME|${ARTIFACT_NAME}|g" \
              .github/release-template.md > release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
