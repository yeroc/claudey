name: Release

on:
  push:
    tags:
      - '*-*'

permissions:
  contents: write

jobs:
  setup:
    name: Setup Release
    runs-on: ubuntu-latest
    outputs:
      module: ${{ steps.parse_tag.outputs.module }}
      version: ${{ steps.parse_tag.outputs.version }}
      artifact_name: ${{ steps.parse_tag.outputs.artifact_name }}
    steps:
      - name: Parse Tag
        id: parse_tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Tag: $TAG"
          
          # Extract module (everything before the first hyphen followed by a digit)
          MODULE=${TAG%%-[0-9]*}
          # Extract version (remove module and hyphen from tag)
          VERSION=${TAG#$MODULE-}
          
          echo "Module: $MODULE"
          echo "Version: $VERSION"
          
          echo "module=$MODULE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact_name=mcp-$MODULE-server" >> $GITHUB_OUTPUT

  test:
    name: Run Tests
    needs: setup
    uses: ./.github/workflows/_test.yml
    with:
      maven_args: 'clean verify -pl ${{ needs.setup.outputs.module }} -am -Drevision=${{ needs.setup.outputs.version }}'
      run_sqlite: false # Usually release tests might run less variants or same. Original didn't have SQLite explicit block.

  build-jar:
    name: Build JAR
    needs: [setup, test]
    uses: ./.github/workflows/_build-jar.yml
    with:
      maven_args: 'clean package -pl ${{ needs.setup.outputs.module }} -am -DskipTests -Drevision=${{ needs.setup.outputs.version }}'
      artifact_name: '${{ needs.setup.outputs.artifact_name }}-*.jar'
      upload_name: jar
      retention_days: 5

  build-native:
    name: Build Native
    needs: [setup, test]
    uses: ./.github/workflows/_build-native.yml
    with:
      maven_args: 'clean package -pl ${{ needs.setup.outputs.module }} -am -Dnative -DskipTests -Drevision=${{ needs.setup.outputs.version }}'
      artifact_name: '${{ needs.setup.outputs.artifact_name }}-*'
      retention_days: 5
    secrets: inherit

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [setup, test, build-jar, build-native]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: ls -R artifacts/

      - name: Prepare release files
        run: |
          mkdir release-files
          ARTIFACT_NAME=${{ needs.setup.outputs.artifact_name }}
          # Flatten artifacts
          find artifacts -type f -name "${ARTIFACT_NAME}-*" -exec cp {} release-files/ \;
          ls -lh release-files/

      - name: Generate release notes
        run: |
          VERSION=${{ needs.setup.outputs.version }}
          REPO=${{ github.repository }}
          ARTIFACT_NAME=${{ needs.setup.outputs.artifact_name }}
          TAG=${{ github.ref_name }}

          # Generate release notes from template
          sed -e "s|{{VERSION}}|${VERSION}|g" \
              -e "s|{{TAG}}|${TAG}|g" \
              -e "s|{{REPO}}|${REPO}|g" \
              -e "s|{{ARTIFACT_NAME}}|${ARTIFACT_NAME}|g" \
              .github/release-template.md > release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
